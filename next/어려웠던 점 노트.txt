어려웠던 점 노트


1

채팅창을 구현할 때

채팅방에 대한 정보를 담고있는 데이터 컬렉션이 있고

채팅방 채팅내역만 담고있는 데이터 컬렉션을 각각 별개로 설계했다

처음 로그인할 때 

session 상태의 변화에 따라 발동되는 useEffect 내에서

함수가 하나 발동하는데

이 때 두 가지 기능이 작동된다 

첫 번째는 일단 채팅방 채팅내역을 담고있는 데이터 컬렉션 자체를 구독을 한다 
(그래야 처음 메세지를 보낸 사람의 메세지를 알림으로 받을 수 있기 때문에)

두 번째는 본인의 계정(=이메일)이 채팅방의 인원으로 기록되어 있는 채팅방에 대한 정보를 담고있는 데이터들만 뽑아서 배열로 만들어 setState 하는 함수(이하 채팅정보저장함수)가 발동한다 
(본인의 전체 채팅 리스트를 받아오는 작업)

이 때 첫 번째 기능인 구독을 하는 과정에서 콜백함수를 설정할 수 있는데 이 콜백함수는 내가 구독한 채팅방 채팅내역 컬렉션에 변화가 발동될 때마다 발동되는 함수이다

그런데 이 함수는 모든 이용자들의 데이터의 상황의 변화에 따라 항상 발동하기 때문에 

내 데이터가 바뀔 때만 특정 작업이 발동되게끔 조건문을 걸어준다 (즉 내가 채팅을 보내거나 특정유저가 내게 채팅을 보냈을 때만 발동되는 조건)

이 조건문 안에서는 채팅정보저장함수에 변수로 내 계정, 내 계정과 메세지를 보내는 대상의 계정이 담긴 배열, 마지막에 보낸 채팅데이터를 넣어서 발동 시키고

채팅정보저장함수는 실시간으로 받게 되는 변수들로 내 채팅방에 대한 정보들을 변환한 후 데이터들을 프론트 쪽에 setState 해준 뒤 바뀐 데이터를 반환한다

그리고 그 반환된 데이터를 포켓베이스(백엔드 서버 기능을 담당)에 업데이트 요청을 보내서 실시간으로 데이터가 수정되는 구조이다

여기서 문제가 발생하는데

내 채팅창 데이터가 바뀐다는 뜻은 이 채팅방에 들어와있는 다른 사람도 자신의 채팅창의 데이터가 바뀐다는 뜻으로

결론적으로 내가 메세지를 보내서 채팅내역이 바뀌게 되면 나와 상대방 쪽 모두에게 변화가 감지되어 

동일한 변환된 데이터를 양측에서 모두 서버에 업데이트 요청을 보낸다는 것이다

즉 중복된 데이터가 동시에 요청이 된다는 뜻인데 이 때 에러가 나게 된다

동일한 일시에 복수의 요청을 서버에서 처리하지 못하고 에러가 나게 되는 것인데 이 점을 찾지 못해 난항을 겪다가

조건문으로 메세지를 보냈을 때 해당 메세지 데이터 객체 상의 보낸사람 property가 자신의 세션 아이디와 동일할 때만 요청을 보내라고 설정을 했다

그랬더니 보낸사람 측에서만 요청이 보내져서 에러가 사라졌다









 